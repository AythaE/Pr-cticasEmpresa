# Diario
En este fichero iré recogiendo las cosas que voy haciendo diariamente para que facilite la posterior escritura de la memoria.

## 03/07/2017
Primer día, instalación de diversas herramientas e intentos de despliegue en docker con problemas por falta de base de datos y acceso a repositorios.

## 04/07/2017
Arreglado despliegue de docker, realizado la primera aportación el repositorio base2 con la documentación actualizada para desplegar el en docker

## 05/07/2017
He estado haciendo el tutoral de AngularJS 1.x <https://www.codeschool.com/courses/shaping-up-with-angularjs> el cuál he subido a un repo propio de gitlab. En el daily scrum se me asignó llevar a cabo un CRUD de otro elemento sobre el repositorio base2 a modo de entrenamiento. Intenté comenzar pero el tutorial me llevó algo más de tiempo del esperado así que comenzaré mañana con ello.

## 06/07/2017
He estado intentando crear un CRUD a partir de RestItem sobre el repositorio base2, de igual manera que se realiza con usuarios. Estoy teniendo algunos problemas para comprender el código debido a que incluye bastantes cosas y a que no puedo realizar pruebas sin desplegar toda la aplicación. Sobre la aplicación he estado probando a crear usuarios pero se produce un error tras introducir el Email, lo que impide que pueda ver como se añaden usuarios. He creado el esqueleto de una clase Ec2Instance apartir del de usuario, pero debería de probar como funciona antes usuarios.

## 10/07/2017
Hoy he continuado con el CRUD de instancias AWS sobre el proyecto Bat. He tenido diversos problemas con la api de usarios que no me ha permitido ver en funcionamiento el alta y modificación de estos. Aún así he creado una rama en dicho proyecto, llamada crud_ec2instance en la que he añadido la parte correspondiente al backend de este CRUD aunque no esté totalmente operativa aún. Para probar las apis he estado usando la herramienta Postman logrando hacer algunas pruebas con la api de usuarios.

## 11/07/2017
He estado instalando y jugando el la rama LabDay del repositorio de APM ya que lleva un ejemplo de aplicación más simple que el de usuarios lo que me ha ayudado a entender la lógica de rest_item. He estado teniendo problemas para realizar peticiones post usando postman, probablemente debido al token csrf, pero he encontrado la herramienta postman interceptor que permite redirigir las peticiones a postman, con ello podre copiar los headers de un post hecho desde la UI web y poder realizar el testeo de mi API, también he estado modificando algunas cosillas que no eran necesarias de mi clase pero que inicialmente añadí por estar en usuarios sin entender muy bien como funcionaba.

## 12/07/2017
Hoy he logrado testear en postman adecuadamente, he sido añadido en jira y tengo asignada mi primera tarea del listado de instancias. Sigo teniendo problemas para hacer funcionar mi backend de instancias a pesar de haberlo simplificado tras haber aclarado algunos conceptos en el daily scrum de hoy. En concreto estoy teniendo un problema para insertar usando services.py de apm donde se produce un error 400 con el mensaje "extra keys not allowed"

## 13/07/2017
Hoy por fin he logrado hacer funcionar el CRUD de instancias, los problemas de ayer se debían a que era necesario incluir los campos \_id y deleted en las validaciones de mi clase. He comenzado por tanto a recuperar la lista de instancias de AWS partiendo del código disponible en nucleoo usando boto, para ello he configurado los credenciales de aws de mi cuenta de estudiante para hacer pequeñas pruebas, con ello he añadido un método nuevo para refrescar la lista, el cual será invocado al pulsar un botón de refresco, no he tenido tiempo para testearlo completamente aún y por ahora solo añadiría a la BD las instancias recuperadas de AWS.

## 14/07/2017
Hoy he configurado los credenciales de aws en el contenedor usando un volumen que mapea los del anfitrión, simplificando el proceso. Con esto he sido capaz de implementar un método de refresco de la lista de instancias que descarga las instancia asociadas a la cuenta de bi4. Adicionalmente he estado implementando la parte del front end dejando preparada la lista con los campos id, nombre, estado e ip, también contiene un botón de refresco que lanza el método mencionado previamente y muestra el tiempo de refresco. A pesar de esto ha faltado que la búsqueda y ordenación de la tabla por columnas.

## 17/07/2017
En el stand-up de hoy se me comentó que tendria que añadir el campo uptime y un boton para permitir arrancar o parar instancias de aws, además de eso arreglé la ordenación por columnas así como la busqueda por nombre e id de instancia. Para parar y arrancar instancias me he basado en el código del script instances_management_aws creando mis propios métodos en la clase EC2instance, casi al final del día cristina me comentó que sería mejor usar directamente los métodos de dicho script ya que notificarían por el canal de slack creado para ello. También he estado retocando el refresh, haciendo que se varíe al establecer un watcher de angularjs sobre vm.data.list con lo que variará cada vez que se actualice la lista. Con esto prácticamente queda acabado el crud de instancias a falta de relizar un merge sobre la rama y modificar los métodos de start y stop de instancias.

## 18/07/2017
Hoy he estado fusionando mi rama con la rama 1.0.1 del sprint actual, he tenido que realizar múltiples cambios debido a los conflictos existentes, ya que cristina usaba la clase server para trabajar con los schedules. Han surgido multiples problemas, se ha caido el servidor de desarrollo, hemos tenido que hardcodear la base de datos por los fallos del script initialize db. Al final he dejado el merge request sin conflictos y se lo he asignado a juan.

## 19/07/2017
He tenido que resolver un conflicto nuevo con el merge de instancias pero por fin se encuentra fusionado en la rama del sprint actual (1.0.1). Tras esto he estado realizando la tarea CIP-49 que consistía en modificar diversas cosillas del front-end como personalzar la vista de login (para lo que he realizado un logo), reordenar las pestañas para que se muestre primero la de servidores... Durante esta tarea me percaté de que si se accede a la raiz de la página (http://dominio.com/) se carga por defecto una pestaña, pero esta no aparece como destacada, cosa que si pasa si se hace click en ella, comentando esto en la reunión diaria me dijeron que era un bug que estaba arreglado en Nucleoo así que tendré que mirarlo mañana. Como antes de la reunión ya pensé que habia acabado esa tarea cogí la tarea de inicializar la base de datos correctamente, inicialmente estaba asignada a Alex quien ya habia estado llevando a cabo algunas tareas. Para inicializar la base de datos es necesario lanzar el script create_customer que inicializa la base de datos cip_security y añade un cliente, tras esto hay que invocar initialize_db que crea las colecciones con los documentos por defecto para el customer concreto en su bd dedicada y por último ejecutar initialize_db_docker encargado de añadir un usuario admin. En el primero de estos pasos se producía un error porque fallaba al añadir un customer a la bd debido a la falta de validaciones en la clase customer del paquete multiclient, por ello he creado una rama nueva en dicho repositorio donde partiendo de la rama de Alex 2to3 he añadido las modificaciones pertinentes y he dejado un merge request hecho sobre la rama de Alex. Con estos cambios he sido capaz de ejecutar el script create_customer satisfactoriamente.

## 20/07/2017
Continuando con la tarea de inicializar la base de datos correctamente modifique el script initialize_db para añadir un usuario administrador a la base de datos si se le pasaba un parámetro, además analizando el código existente sobre customers me surgio una duda de para que usaba el campo security, ya que en nuestros scripts siempre estaba a false pero viendo los de otros proyectos aparecia a true. Por ello tras una charla con Juan y Francisco Javier entendí que servia para crear un customer "super-admin" que gestionara la base de datos security, por eso lo añadí en un inicialize_db_docker, el cual invoca a create_customer, que a su vez llama a initialize_db con lo que queda preparada la inicialización de la BD ejecutando un solo script. Adicionalmente realicé algunas modificaciones sobre la parte de gestión de servidores como añadir un spinner estático en caso de estado inestable para mejorar su usabilidad.ç

## 21/07/2017
Hoy he llegado más tarde debido a que he ido a ver la presentación del TFM de mi pareja, tras comentarlo con Natalia me dijo que no habia problema y que me podía quedar a una Meet up de Alberto después de comer para compensar las horas. Respecto a las tareas actualicé la documentación para que reflejara el nuevo modo de inicialización de la BD. Añadí mensajes de confirmación en la parte de servidores para no parar/arrancar un servidor por error, además introduje mensajes en forma de toast en caso de errores para proveer algo de feedback al usuario y que no piense que se ha quedado colgada la aplicación. También arreglé el problema de que no se marcaba la pestaña por defecto al acceder a la raíz de la página web fijandome en el código de nucleoo, esto unido a algunos fixes de interfaz gráfica menores como personalizar la pantalla de login o reordenar las pestañas que ya tenia hechos previamente me permitieron dar por finalizada la tarea que ya se encuentra fusionada en la rama del sprint.

## 24/07/2017
Hoy he estado arreglando el bug que imposibilitaba añadir usuarios, ha sido más complejo de lo esperado ya que tiene que ver con la jerarquía de APM debido a que el usuario hereda del de APM y no permitia añadir validaciones propia, por lo que fallaba al insertar algun campo que no estuviera en la clase user de apm, esto lo he arreglado reescribiendo el método en mi clase aunque sea un poco repetir el código pero comentandolo con Juan decidimos eso más que cambiar en APM (aunque solo haría falta cambiar una linea del método validate). Tras resolver esto me dio un extraño error sobre los parser de los campos de data que son datetimes, estos se reciben como strings y con dichos parsers se convierten a datetimes, tras una intensa depuración descubrí que por algún motivo los parsers se estaban declarando dos veces, por lo que la segunda vez intentaba convertir un datetime a datetime con el consecuente fallo, para arreglar esto he encontrado un workarround que se basa en eliminar elementos duplicados de la lista de parsers.

## 25/07/2017
Tras todos los problemas de ayer por fin he logrado hacer funcionar el añadir usuarios, con esto también se logra que funcione el modificarlos. He estado realizando modificaciones en el parte de servidores, añadiendo spinner dinámico mientras se arranca o para. Comenzé la tarea de gestión de roles para lo que añadí un campo bool accessible en todos los servidores que permitirá al administrador marcar los servidores que podrán modificar los usuarios normales.

## 26/07/2017
Hoy he llegado algo más tarde porque he tenido que ir al médico. He estado modificando una vez más la vista de servidores con los comentarios que se hicieron en la reunión y continué trabajando en los roles, fijándome como estaba implementada esta funcionalidad en nucleoo he creado un rest_item role cuya colección contendrá todos los roles existentes que serán fijados al unicializar la base de datos. Por ahora solo se dispone de un rol admin y uno standard user. En la ventana de profile se puede observar ya un desplegable con los roles disponibles para su asignación pero me ha quedado guardarlos y que se apliquen realmente

## 27/07/2017
Utilizando los roles creados ayer y fijandome en como se aplican en nucleoo he logrado que se guarden dichos roles, pero usando la un dropdown de selección múltiple que en este caso no tiene mucho sentido al existir solo 2 roles, por ello tendré que cambiarlo después. Hoy he logrado que se guarden realmente los roles en la BD y he estado preparando las vistas para los usuarios estándar, filtrando las listas de servidores para mostrar aquellos a los que se tiene acceso desde el back-end, retocando los diversos métodos del backend para permitir el acceso de usuarios sin privilegios y modificando los permisos de acceso a las diversas vistas que han de tener esos usuarios en el frontend.

## 28/07/2017
Hoy he estado ultimando el trabajo de ayer añadiendo los scripts de migración de de la BD para que contenga el atributo accesible en los servidores así como la colección de roles. Para ello me he fijado en los scripts de migración ya existentes y me he visto obligado a modificarlos todos ya que realizaban las migraciones sobre la BD por defecto del proyecto en lugar de buscar la BD del customer concreto que se quiera migrar, por ello he añadido un script que a partir del nombre del customer devuelve su base de datos asociada consultando la BD security y las migraciones pertinentes se aplican sobre la misma. Estuve convirtiendo el dropdown de selección de roles en selección única, pense que sería algo trivial pero al solo seleccionar una en lugar de contar con un array de roles la selección devolvía una cadena de caracteres por lo que tuve multiples problemas hasta que logré hacer que funcionara como se esperaba.

## 31/07/2017
Hoy he acabado la gestión de roles tras revisar que lo que hice el último día funcionaba adecuadamente. Además he hecho un pequeño cambio en la lista de servidores de modo que se muestre el toast de éxito arrancando/parando instancias cuando estas hayan llegado a estado estable, no cuando se haya invocado el método. Tras esto he comenzado la tarea de gestión de credenciales AWS, para ello haré una primera versión que permita al administrador fijar los credenciales desde el front end, los cuales se guarden en un fichero en la ruta que espera boto para conectarse. Estos credenciales no harán uso de perfiles por lo que serán únicos para todos los usuarios, pero los intentaré gestionar de forma que su extensión resulte sencilla. Por ello he creado un rest_item Aws_credencials que permite gestionar una coleción homónima, creando el fichero mencionado cuando se añadan o modifiquen credenciales de aws, eliminando el fichero si se eliminan los credenciales. He llegado a hacer el backend, pero parece haber algún comportamiento extraño con la black_list lo que permite ver la secret_access_key.

## 01/08/2017
He continuado con la tarea de gestión de credenciales AWS, en la stand-up de hoy acordé con Cristina encriptar la secret key para que no se almacenara en plano en la BD, para ello me he valido de una implementación utilizada en Nucleoo donde a partir de una clave de encriptación maestra se le aplica un md5 y un algoritmo PBKDF2 para generar una clave secreta la cual se utiliza en un AES para encriptar o desencriptar dicho campo de los credenciales, el campo por tanto se guarda como un dato binario en la bd, el cual se desencripta para escribir el fichero de credenciales usado por boto para conectarse a aws, ademas de esto he estado trabajando en el front end llegando a la conclusión de que para poder añadir una pestaña en settings que permita fijar los credenciales mediante 2 input es necesario añadir un nuevo bool a todos los settings que he llamado "exrensible" que permite determinar si se pueden añadir más valores al setting, por ello ese valor sería true en userfields y false en aws credentials. Con esto podre filtrar en el front end y mostrar campos de texto asociados a cada uno de los valores que son fijados en la inicialización de la bd.

## 02/08/2017
Hoy he acabado el front de la gestión de credenciales de aws, para ello he realizado el filtrado que comenté ayer y he añadido 2 input (uno de texto y otro de password) para insertar los credenciales, he intentado realizar esto de manera que no rompa con la lógica de settings previa y de que sea facilmente extensible para añadir nuevos settings con la nueva lógica usando un array de servicios específicos asociados a cada uno de los settings nuevos. He borrado el setting userFields porque no se iba a usar, he arreglado el rest_item de settings porque no funcionaba debido a las validaciones. También he estado modificando los mensajes de éxito o error al refrescar la lista de servidores para controlar cuando si se ha producido un error de autenticación por no haber introducido credenciales de aws o haber introducido unos incorrectos mostrando mensajes de error diferentes en función del error en el toast con el consejo de que se revisen los credenciales.
